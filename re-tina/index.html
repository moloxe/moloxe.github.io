<!DOCTYPE html><html lang="en"> <head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0"><meta property="og:title" content="Tina"><meta name="twitter:title" content="Tina"><!-- <meta property="og:url" content={canonicalHref} /> --><meta name="generator" content="Astro v5.16.9"><title>Tina</title><link rel="icon" type="image/svg+xml" href="/favicon.svg"><!-- <link rel="canonical" href={canonicalHref} /> --><meta name="astro-view-transitions-enabled" content="true"><meta name="astro-view-transitions-fallback" content="animate"><script type="module" src="/_astro/ClientRouter.astro_astro_type_script_index_0_lang.CDGfc0hd.js"></script><link rel="stylesheet" href="/_astro/ants-test.DJx1_YBF.css">
<style>/*! tailwindcss v4.1.18 | MIT License | https://tailwindcss.com */a[data-astro-cid-ob7qyy3l]{color:var(--primary)}.tina-logo[data-astro-cid-ob7qyy3l]{filter:grayscale()contrast(1.5)brightness(6)invert()opacity(.8);border-radius:8px}
pre code.hljs{display:block;overflow-x:auto;padding:1em}code.hljs{padding:3px 5px}.hljs{color:#abb2bf;background:#282c34}.hljs-comment,.hljs-quote{color:#5c6370;font-style:italic}.hljs-doctag,.hljs-formula,.hljs-keyword{color:#c678dd}.hljs-deletion,.hljs-name,.hljs-section,.hljs-selector-tag,.hljs-subst{color:#e06c75}.hljs-literal{color:#56b6c2}.hljs-addition,.hljs-attribute,.hljs-meta .hljs-string,.hljs-regexp,.hljs-string{color:#98c379}.hljs-attr,.hljs-number,.hljs-selector-attr,.hljs-selector-class,.hljs-selector-pseudo,.hljs-template-variable,.hljs-type,.hljs-variable{color:#d19a66}.hljs-bullet,.hljs-link,.hljs-meta,.hljs-selector-id,.hljs-symbol,.hljs-title{color:#61aeee}.hljs-built_in,.hljs-class .hljs-title,.hljs-title.class_{color:#e6c07b}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}.hljs-link{text-decoration:underline}
</style></head> <body> <img class="absolute w-0 h-0" src="https://librecounter.org/counter.svg" loading="eager" decoding="async" referrerpolicy="unsafe-url" id="libre-counter"> <div class="absolute w-0 h-0" data-astro-transition-persist="astro-bfx3ztbg-1"> <style>astro-island,astro-slot,astro-static-slot{display:contents}</style><script>(()=>{var e=async t=>{await(await t())()};(self.Astro||(self.Astro={})).load=e;window.dispatchEvent(new Event("astro:load"));})();</script><script>(()=>{var A=Object.defineProperty;var g=(i,o,a)=>o in i?A(i,o,{enumerable:!0,configurable:!0,writable:!0,value:a}):i[o]=a;var d=(i,o,a)=>g(i,typeof o!="symbol"?o+"":o,a);{let i={0:t=>m(t),1:t=>a(t),2:t=>new RegExp(t),3:t=>new Date(t),4:t=>new Map(a(t)),5:t=>new Set(a(t)),6:t=>BigInt(t),7:t=>new URL(t),8:t=>new Uint8Array(t),9:t=>new Uint16Array(t),10:t=>new Uint32Array(t),11:t=>1/0*t},o=t=>{let[l,e]=t;return l in i?i[l](e):void 0},a=t=>t.map(o),m=t=>typeof t!="object"||t===null?t:Object.fromEntries(Object.entries(t).map(([l,e])=>[l,o(e)]));class y extends HTMLElement{constructor(){super(...arguments);d(this,"Component");d(this,"hydrator");d(this,"hydrate",async()=>{var b;if(!this.hydrator||!this.isConnected)return;let e=(b=this.parentElement)==null?void 0:b.closest("astro-island[ssr]");if(e){e.addEventListener("astro:hydrate",this.hydrate,{once:!0});return}let c=this.querySelectorAll("astro-slot"),n={},h=this.querySelectorAll("template[data-astro-template]");for(let r of h){let s=r.closest(this.tagName);s!=null&&s.isSameNode(this)&&(n[r.getAttribute("data-astro-template")||"default"]=r.innerHTML,r.remove())}for(let r of c){let s=r.closest(this.tagName);s!=null&&s.isSameNode(this)&&(n[r.getAttribute("name")||"default"]=r.innerHTML)}let p;try{p=this.hasAttribute("props")?m(JSON.parse(this.getAttribute("props"))):{}}catch(r){let s=this.getAttribute("component-url")||"<unknown>",v=this.getAttribute("component-export");throw v&&(s+=` (export ${v})`),console.error(`[hydrate] Error parsing props for component ${s}`,this.getAttribute("props"),r),r}let u;await this.hydrator(this)(this.Component,p,n,{client:this.getAttribute("client")}),this.removeAttribute("ssr"),this.dispatchEvent(new CustomEvent("astro:hydrate"))});d(this,"unmount",()=>{this.isConnected||this.dispatchEvent(new CustomEvent("astro:unmount"))})}disconnectedCallback(){document.removeEventListener("astro:after-swap",this.unmount),document.addEventListener("astro:after-swap",this.unmount,{once:!0})}connectedCallback(){if(!this.hasAttribute("await-children")||document.readyState==="interactive"||document.readyState==="complete")this.childrenConnectedCallback();else{let e=()=>{document.removeEventListener("DOMContentLoaded",e),c.disconnect(),this.childrenConnectedCallback()},c=new MutationObserver(()=>{var n;((n=this.lastChild)==null?void 0:n.nodeType)===Node.COMMENT_NODE&&this.lastChild.nodeValue==="astro:end"&&(this.lastChild.remove(),e())});c.observe(this,{childList:!0}),document.addEventListener("DOMContentLoaded",e)}}async childrenConnectedCallback(){let e=this.getAttribute("before-hydration-url");e&&await import(e),this.start()}async start(){let e=JSON.parse(this.getAttribute("opts")),c=this.getAttribute("client");if(Astro[c]===void 0){window.addEventListener(`astro:${c}`,()=>this.start(),{once:!0});return}try{await Astro[c](async()=>{let n=this.getAttribute("renderer-url"),[h,{default:p}]=await Promise.all([import(this.getAttribute("component-url")),n?import(n):()=>()=>{}]),u=this.getAttribute("component-export")||"default";if(!u.includes("."))this.Component=h[u];else{this.Component=h;for(let f of u.split("."))this.Component=this.Component[f]}return this.hydrator=p,this.hydrate},e,this)}catch(n){console.error(`[astro-island] Error hydrating ${this.getAttribute("component-url")}`,n)}}attributeChangedCallback(){this.hydrate()}}d(y,"observedAttributes",["props"]),customElements.get("astro-island")||customElements.define("astro-island",y)}})();</script><astro-island uid="1EHrjx" prefix="s0" component-url="/_astro/index.0BedYp8Q.js" component-export="default" renderer-url="/_astro/client.BZ2AD0De.js" props="{}" ssr client="load" opts="{&quot;name&quot;:&quot;OnekoStack&quot;,&quot;value&quot;:true}" await-children><!--[--><!--]--><!--astro:end--></astro-island> </div> <p class="text-sm font-mono px-4 pt-2 pb-8 text-neutral-400 leading-5 break-all max-sm:text-xs max-sm:pb-4 max-sm:px-2"> <a href="/" class="hover:text-white">Home</a>  / <a href="/re-tina" class="hover:text-white">re-tina</a>  </p>  <main class="flex flex-col gap-10 p-2 justify-center w-full max-w-2xl m-auto" data-astro-cid-ob7qyy3l> <div class="flex w-full items-end gap-4" data-astro-cid-ob7qyy3l> <p class="text-4xl font-mono mb-[6%]" data-astro-cid-ob7qyy3l>Re</p> <div data-astro-cid-ob7qyy3l> <img src="/_astro/tina.4YsElRAf.jpeg" alt="Tina logo" class="tina-logo" data-astro-cid-ob7qyy3l> </div> </div> <div data-astro-cid-ob7qyy3l>ReTina, raymarch engine for the gang.</div> <astro-island uid="1NLXWw" component-url="/_astro/ReTinaExamples.CWJSsyR4.js" component-export="default" renderer-url="/_astro/client.DZgfbRuh.js" props="{&quot;examples&quot;:[1,[[0,{&quot;route&quot;:[0,&quot;basic-cursors&quot;],&quot;sketch&quot;:[0,&quot;import ReTina from &#39;../_lib/ReTina/ReTina&#39;\r\nimport {\r\n  init,\r\n  changeState,\r\n  listener,\r\n  close,\r\n  getMyId,\r\n} from &#39;../../../shared/ants&#39;\r\n\r\ntype AntState = {\r\n  x: number\r\n  y: number\r\n  id: string\r\n}\r\n\r\nconst MAX_ANTS = 100\r\n\r\nconst rt = new ReTina({\r\n  transparent: true,\r\n  texs: [{ width: MAX_ANTS, height: 1 }], // Texture for ant positions\r\n  functions: /* wgsl */ `\r\n    fn unpack(h: f32, l: f32) -&gt; f32 {\r\n      // Reconstruct 16-bit value from two 8-bit normalized floats\r\n      // h is high byte/255, l is low byte/255\r\n      let high = h * 255.0;\r\n      let low = l * 255.0;\r\n      let val16 = high * 256.0 + low;\r\n      return val16 / 65535.0;\r\n    }\r\n\r\n    fn circle(uv: vec2f, center: vec2f, radius: f32) -&gt; f32 {\r\n        let d = length(uv - center);\r\n        return 1.0 - smoothstep(radius, radius + 2.0, d);\r\n    }\r\n  `,\r\n  main: /* wgsl */ `\r\n    let xy = uv * vec2f(U.width, U.height);\r\n    var color = vec4f(0); // Background\r\n\r\n    // Draw other ants\r\n    let count = i32(U.antCount);\r\n    for (var i: i32 = 0; i &lt; count; i++) {\r\n        // Load packed position from texture\r\n        // Texture is 100x1\r\n        let texVal = textureLoad(tex0, vec2&lt;i32&gt;(i, 0), 0);\r\n        let ax = unpack(texVal.r, texVal.g);\r\n        let ay = unpack(texVal.b, texVal.a);\r\n        let pos = vec2f(ax, ay) * vec2f(U.width, U.height);\r\n\r\n        // Simple visual for ant: Circle\r\n        // Different color based on ID/Index? We don&#39;t have ID in texture, just index.\r\n        let hue = f32(i) / f32(10.0);\r\n        let antColor = hsv2rgb(vec3f(hue, 0.8, 0.9));\r\n        let c = circle(xy, pos, 15.0);\r\n        color = mix(color, vec4f(antColor, 1), c);\r\n    }\r\n\r\n    // Draw local mouse (white ring)\r\n    let mousePos = vec2f(U.mouseX, U.mouseY);\r\n    let m = circle(xy, mousePos, 10.0) - circle(xy, mousePos, 8.0); \r\n    color = mix(color, vec4f(1, 0, 0, 1), max(0.0, m));\r\n\r\n    return color;\r\n  `,\r\n})\r\n\r\nconst setMouseX = rt.registerUniform(&#39;mouseX&#39;)\r\nconst setMouseY = rt.registerUniform(&#39;mouseY&#39;)\r\nconst setAntCount = rt.registerUniform(&#39;antCount&#39;)\r\n\r\n// Helper to pack float 0..1 into two bytes [high, low]\r\nfunction pack16(val: number) {\r\n  const v = Math.max(0, Math.min(1, val)) * 65535\r\n  const high = Math.floor(v / 256)\r\n  const low = Math.floor(v % 256)\r\n  return [high, low]\r\n}\r\n\r\nrt.start({\r\n  onBuild() {\r\n    init()\r\n\r\n    const myId = getMyId()\r\n\r\n    listener((states: AntState[]) =&gt; {\r\n      const remoteAnts = states.filter(\r\n        (s) =&gt;\r\n          s.id &amp;&amp;\r\n          s.id !== myId &amp;&amp;\r\n          typeof s.x === &#39;number&#39; &amp;&amp;\r\n          typeof s.y === &#39;number&#39;\r\n      )\r\n\r\n      setAntCount(remoteAnts.length)\r\n\r\n      // Update texture\r\n      const data = new Uint8Array(MAX_ANTS * 4) // RGBA per pixel\r\n      remoteAnts.forEach((ant, i) =&gt; {\r\n        if (i &gt;= MAX_ANTS) return\r\n\r\n        const [xh, xl] = pack16(ant.x)\r\n        const [yh, yl] = pack16(ant.y)\r\n\r\n        const idx = i * 4\r\n        data[idx] = xh // R\r\n        data[idx + 1] = xl // G\r\n        data[idx + 2] = yh // B\r\n        data[idx + 3] = yl // A\r\n      })\r\n\r\n      rt.setTex(0, data)\r\n    })\r\n\r\n    document.addEventListener(&#39;mousemove&#39;, (event) =&gt; {\r\n      const rect = rt.canvas.getBoundingClientRect()\r\n      const x = event.clientX - rect.left\r\n      const y = event.clientY - rect.top\r\n      setMouseX(x)\r\n      setMouseY(y)\r\n\r\n      const nx = x / rect.width\r\n      const ny = y / rect.height\r\n\r\n      changeState({ id: myId, x: nx, y: ny })\r\n    })\r\n\r\n    window.addEventListener(&#39;beforeunload&#39;, () =&gt; {\r\n      close()\r\n    })\r\n  },\r\n})\r\n&quot;]}],[0,{&quot;route&quot;:[0,&quot;basic-game-of-life&quot;],&quot;sketch&quot;:[0,&quot;import { ReTina } from &#39;@ReTina&#39;\r\nimport TinaLogo from &#39;@src/assets/img/tina.jpeg&#39;\r\nimport { loadImage } from &#39;./utils/loadImage&#39;\r\n\r\nconst img = await loadImage(TinaLogo.src)\r\n\r\nconst rt = new ReTina({\r\n  fps: 24,\r\n  height: 128,\r\n  texs: [{ width: img.width, height: img.height }],\r\n  usePrevFrameTex: true,\r\n  functions: /* wgsl */ `\r\n    fn isPixAlive(pos: vec2f) -&gt; vec3f {\r\n      return step(vec3f(0.5), getPrevFrameTexSample(pos).rgb);\r\n    }\r\n    fn golRule(_isAlive: f32, _nCount: f32) -&gt; f32 {\r\n      let isAlive = round(_isAlive) &gt; 0.5;\r\n      let nCount = round(_nCount);\r\n      if isAlive {\r\n        if nCount == 2 || nCount == 3 {\r\n          return 1f;\r\n        }\r\n      } else if nCount == 3 {\r\n        return 1f;\r\n      }\r\n      return 0f;\r\n    }\r\n  `,\r\n  main: /* wgsl */ `\r\n    if (U.time &lt; 1) {\r\n      return getTex0Sample(uv);\r\n    } else {\r\n      let res = vec2f(U.width, U.height);\r\n      var nCount = vec3f(0);\r\n      for (var i = -1; i &lt;= 1; i = i + 1) {\r\n        for (var j = -1; j &lt;= 1; j = j + 1) {\r\n          if (i == 0 &amp;&amp; j == 0) {\r\n            continue;\r\n          }\r\n          let pos = uv + vec2f(f32(i), f32(j)) / res;\r\n          nCount += isPixAlive(pos);\r\n        }\r\n      }\r\n      let isAlive = isPixAlive(uv);\r\n      let newState = vec3f(\r\n        golRule(isAlive.x, nCount.x),\r\n        golRule(isAlive.y, nCount.y),\r\n        golRule(isAlive.z, nCount.z)\r\n      );\r\n      return vec4f(newState, 1);\r\n    }\r\n  `,\r\n})\r\n\r\nrt.start({\r\n  onBuild() {\r\n    rt.setTex(0, img.textureData)\r\n  },\r\n})\r\n&quot;]}],[0,{&quot;route&quot;:[0,&quot;basic-voronoi&quot;],&quot;sketch&quot;:[0,&quot;import { ReTina } from &#39;@ReTina&#39;\r\n\r\nconst rt = new ReTina({\r\n  functions: /* wgsl */ `\r\n    const nPoints = 7;\r\n    fn pdist(pos1: vec2f, pos2: vec2f) -&gt; f32 {\r\n      return pow(\r\n        pow(abs(pos1.x - pos2.x), U.power) +\r\n        pow(abs(pos1.y - pos2.y), U.power), 1 / U.power);\r\n    }\r\n  `,\r\n  main: /* wgsl */ `\r\n    let xy = uv * vec2f(U.width, U.height);\r\n\r\n    var minD = 1e9;\r\n    var minIndex = -1;\r\n    let t = (U.time + U.timestamp) * 0.01;\r\n    for (var i: i32 = 0; i &lt; nPoints; i++) {\r\n      let x = (snoise(vec2f(f32(i), t)) * 0.5 + 0.5) * U.width;\r\n      let y = (snoise(vec2f(f32(i) + 1e3, t)) * 0.5 + 0.5) * U.height;\r\n      let dist = pdist(xy, vec2f(x, y));\r\n      if dist &lt; minD {\r\n        minD = dist;\r\n        minIndex = i;\r\n      }\r\n    }\r\n\r\n    let dMouse = pdist(xy, vec2f(U.mouseX, U.mouseY));\r\n    var hue = f32(minIndex) / f32(nPoints + 1);\r\n    if dMouse &lt; minD {\r\n        hue = f32(nPoints) / f32(nPoints + 1);\r\n        minD = dMouse;\r\n    }\r\n\r\n    var color = hsv2rgb(vec3f(hue + 0.7, .6, .5));\r\n    let bg = hsv2rgb(vec3(.5, .5, .05));\r\n\r\n    color = mix(color, bg, log(minD / 5) / 4);\r\n\r\n    return vec4f(color, 1f);\r\n  `,\r\n})\r\n\r\nconst setMouseX = rt.registerUniform(&#39;mouseX&#39;)\r\nconst setMouseY = rt.registerUniform(&#39;mouseY&#39;)\r\n\r\nrt.registerUniform(&#39;power&#39;, Math.round(1 + Math.random() * 3))\r\nrt.registerUniform(&#39;timestamp&#39;, Date.now() % 1000)\r\n\r\nrt.canvas.style.zIndex = &#39;-1&#39;\r\n\r\nrt.start({\r\n  onBuild() {\r\n    document.addEventListener(&#39;mousemove&#39;, (event) =&gt; {\r\n      setMouseX(event.clientX)\r\n      setMouseY(event.clientY)\r\n    })\r\n  },\r\n})\r\n&quot;]}],[0,{&quot;route&quot;:[0,&quot;rm-collisions&quot;],&quot;sketch&quot;:[0,&quot;import { ReTina } from &#39;@ReTina&#39;\r\n\r\nconst rt = new ReTina({ showFps: true })\r\n\r\nrt.camera.pos.x = -0.25\r\nrt.camera.spherical.theta = -0.4\r\nrt.camera.fov = 60\r\n\r\nconst N = 6\r\n\r\nconst spheres = new Array(N).fill(0).map(() =&gt;\r\n  rt.registerMaterial({\r\n    sdFunc: &#39;return sdSphere(pos, 0.05);&#39;,\r\n    enableCollisions: true,\r\n  })\r\n)\r\n\r\nrt.registerMaterial({\r\n  pos: { x: 0, y: -0.3, z: -0.5 },\r\n  sdFunc: /* wgsl */ `\r\n    return sdBox(pos, vec3f(0.01, 0.15, 0.1));\r\n  `,\r\n})\r\n\r\nsetInterval(() =&gt; {\r\n  for (let index = 0; index &lt; spheres.length; index++) {\r\n    const sphere = spheres[index]\r\n    sphere.checkCollision().then((result) =&gt; {\r\n      if (result.materialIndex !== -1) {\r\n        sphere.setColor({ r: 0.3, g: 0.9, b: 0.3 })\r\n      } else {\r\n        sphere.setColor({ r: 1, g: 1, b: 1 })\r\n      }\r\n    })\r\n  }\r\n}, 1000 / 30)\r\n\r\nrt.start({\r\n  onFrame() {\r\n    const t = performance.now() / 1000\r\n\r\n    for (let index = 0; index &lt; spheres.length; index++) {\r\n      const sphere = spheres[index]\r\n      const angle = t / 2 + (2 * Math.PI * index) / N\r\n\r\n      sphere.setPos({\r\n        x: Math.cos(angle) * 0.2,\r\n        y: Math.sin(angle) * 0.2 + 0.05,\r\n        z: -0.5,\r\n      })\r\n    }\r\n  },\r\n})\r\n&quot;]}],[0,{&quot;route&quot;:[0,&quot;rm-fbm-terrain&quot;],&quot;sketch&quot;:[0,&quot;import { ReTina } from &#39;../_lib&#39;\r\nimport freeControls from &#39;./utils/freeControls&#39;\r\n\r\nconst rt = new ReTina({\r\n  height: 128,\r\n  showFps: true,\r\n  useInterlacing: true,\r\n  main: /* wgsl */ `\r\n    let scene = calcScene(uv);\r\n    var color = vec3f(0);\r\n    if scene.dist &gt; 0 {\r\n        color = scene.color.rgb; \r\n        // Fog\r\n        let dist = scene.dist;\r\n        let fogAmount = 1.0 - exp(-dist * 0.1);\r\n        let fogColor = vec3f(0.5, 0.6, 0.7);\r\n        color = mix(color, fogColor, fogAmount);\r\n    } else {\r\n        // Sky color\r\n        color = vec3f(0.5, 0.6, 0.7) - uv.y * 0.2;\r\n    }\r\n    return vec4f(color, 1);\r\n  `,\r\n  functions: /* wgsl */ `\r\n    const lightColor = vec3f(1.0, 0.9, 0.8);\r\n    const lightPower = 40.0;\r\n    fn getLightPos() -&gt; vec3f {\r\n      return vec3f(0, 8, U.camPosZ - 5);\r\n    }\r\n\r\n    // Fractal Brownian Motion\r\n    fn fbm(p_in: vec3f, OCTAVES: i32) -&gt; f32 {\r\n        var value = 0.0;\r\n        var amplitude = 0.5;\r\n        var frequency = 1.0;\r\n        var p = p_in;\r\n        for (var i = 0; i &lt; OCTAVES; i++) {\r\n            value += amplitude * snoise3d(p * frequency);\r\n            p = p * 2.0;\r\n            frequency *= 1.2;\r\n            amplitude *= 0.5;\r\n        }\r\n        return value;\r\n    }\r\n  `,\r\n})\r\n\r\n// Grass\r\nrt.registerMaterial({\r\n  sdFunc: /* wgsl */ `\r\n    let height = fbm(pos * 0.5, 4) * 2.0;\r\n    var terrain = pos.y - height + 0.2;\r\n    let zone = sdSphere(pos, 2);\r\n    terrain = max(zone, terrain);\r\n    return terrain * 0.2;\r\n  `,\r\n  lightFunc: /* wgsl */ `\r\n    let minBright = 0.1;\r\n    let diffuseColor = vec3f(0.5, 1., 0.5);\r\n    let shininess = 32.0;\r\n    let lightPos = getLightPos();\r\n    let light = blinnPhong(\r\n      // Environment\r\n      rd, normal, minBright,\r\n      // Material\r\n      pos, diffuseColor, shininess,\r\n      // Light\r\n      lightPos, lightColor, lightPower,\r\n    );\r\n    return vec4f(light, 1);\r\n  `,\r\n})\r\n\r\n// Watter\r\nrt.registerMaterial({\r\n  sdFunc: /* wgsl */ `\r\n    let zone = sdSphere(pos, 2);\r\n    return max(zone, pos.y);\r\n  `,\r\n  lightFunc: /* wgsl */ `\r\n    let minBright = 0.1;\r\n    let diffuseColor = vec3f(0.2, 0.6, 1.);\r\n    let shininess = 512.0;\r\n    let lightPos = getLightPos();\r\n    let n = pos + snoise3d(pos);\r\n    let t = U.time * 5;\r\n    let waves = vec3f(sin(n.x * 25 - t) * 0.1, pos.y, cos(n.z * 25 + t) * 0.1);\r\n    let light = blinnPhong(\r\n      // Environment\r\n      rd, normalize(normal + waves), minBright,\r\n      // Material\r\n      pos, diffuseColor, shininess,\r\n      // Light\r\n      lightPos, lightColor, lightPower,\r\n    );\r\n    return vec4f(light, 1);\r\n  `,\r\n})\r\n\r\n// Clouds\r\nrt.registerMaterial({\r\n  sdFunc: /* wgsl */ `\r\n    let zone = sdSphere(pos, 2);\r\n    pos.x += U.time / 30;\r\n    pos.x /= 3;\r\n    pos.z /= 3;\r\n    var cloud =\r\n      pos.y -\r\n      fbm(pos, 4) * 2.0 +\r\n      snoise3d((vec3f(pos.x, pos.y + U.time / 20, pos.z)) * 2.0) * 0.5;\r\n    cloud = opSmoothSubtraction(pos.y - 0.65, cloud, 0.3);\r\n    cloud = max(zone, cloud);\r\n    return cloud * 0.2;\r\n  `,\r\n  lightFunc: /* wgsl */ `\r\n    let minBright = 0.8;\r\n    let diffuseColor = vec3f(0.9, 0.9, 0.9);\r\n    let shininess = 64.0;\r\n    let lightPos = getLightPos();\r\n    let light = blinnPhong(\r\n      // Environment\r\n      rd, normal, minBright,\r\n      // Material\r\n      pos, diffuseColor, shininess,\r\n      // Light\r\n      lightPos, lightColor, lightPower,\r\n    );\r\n    return vec4f(light, 1);\r\n  `,\r\n})\r\n\r\nrt.camera.fov = 50\r\nrt.camera.spherical = { radius: 5, theta: 0.5, phi: -0.5 }\r\n\r\nfreeControls(rt)\r\nrt.start()\r\n&quot;]}],[0,{&quot;route&quot;:[0,&quot;rm-fractal-env&quot;],&quot;sketch&quot;:[0,&quot;import { ReTina } from &#39;@ReTina&#39;\r\nimport freeControls from &#39;./utils/freeControls&#39;\r\n\r\nconst rt = new ReTina({\r\n  showFps: true,\r\n  height: 512,\r\n  useInterlacing: true,\r\n})\r\n\r\n// Based on: https://shaders.skia.org/?id=ed72577c437c036447372e4c873462fc1bbfc0cb5e9fb0630ab1c07368a0db48\r\nrt.registerMaterial({\r\n  sdFunc: /* wgsl */ `\r\n    pos.z -= U.time * 0.5;\r\n    pos = asin(sin(pos)) - vec3&lt;f32&gt;(3.0);\r\n    for (var i = 0; i &lt; 9; i++) {\r\n        pos = abs(vec3&lt;f32&gt;(pos.xz, pos.y).xzy);\r\n        if (pos.x &lt; pos.y) {\r\n            pos = pos.zxy;\r\n        } else {\r\n            pos = pos.zyx;\r\n        }\r\n        pos = pos + pos - vec3&lt;f32&gt;(1.0, 3.0, 7.0);\r\n    }\r\n    let dist = max(pos.x, pos.z) / 1000.0 - 0.01;\r\n    return dist;\r\n  `,\r\n  lightFunc: /* wgsl */ `\r\n    var spec = 0.;\r\n    let lambertian = dot(normal, -rd);\r\n    if lambertian &gt; 0. {\r\n        let lightDir = normalize(ro - pos);\r\n        let halfDir = normalize(lightDir + -rd);\r\n        spec = pow(max(dot(halfDir, normal), 0.), 2000.);\r\n    }\r\n    var dd = length(pos - ro); dd = 1 + (dd * dd  * .01);\r\n    var out = normal * normal;\r\n    out = rgb2hsv(out);\r\n    out = hsv2rgb(vec3&lt;f32&gt;(out.x + U.time * .2 + sin(pos.x + pos.y) / 4., .6, .6));\r\n    out = (out * lambertian + spec) / dd;\r\n    return vec4&lt;f32&gt;(out, 1.);\r\n  `,\r\n})\r\n\r\nrt.camera.fov = 100\r\nrt.camera.spherical = {\r\n  radius: 0,\r\n  phi: 0,\r\n  theta: 0.2,\r\n}\r\n\r\nfreeControls(rt)\r\nrt.start()\r\n&quot;]}],[0,{&quot;route&quot;:[0,&quot;rm-mandelbulb&quot;],&quot;sketch&quot;:[0,&quot;import { ReTina } from &#39;@ReTina&#39;\r\nimport freeControls from &#39;./utils/freeControls&#39;\r\n\r\n// Shader based on: https://webgpulab.xbdev.net/index.php?page=editor&amp;id=mandelbulbbasic3&amp;\r\nconst rt = new ReTina({\r\n  height: 512,\r\n  useInterlacing: true,\r\n  showFps: true,\r\n})\r\n\r\nrt.registerMaterial({\r\n  sdFunc: /* wgsl */ `\r\n    var power = 6 + 4 * sin(U.time * 0.1);\r\n    var z = pos;\r\n    var c = pos;\r\n    var dr = 1.0;\r\n    var r = 0.0;\r\n    for (var i: i32 = 0; i &lt; 16; i++) {\r\n        r = length(z);\r\n        if r &gt; 2.0 { break; }\r\n        var theta = acos(z.z / r);\r\n        var phi = atan2(z.y, z.x);\r\n        dr = pow(r, power - 1.0) * power * dr + 1.0;\r\n        var zr = pow(r, power);\r\n        theta *= power;\r\n        phi *= power;\r\n        z = zr * vec3(sin(theta) * cos(phi), sin(phi) * sin(theta), cos(theta));\r\n        z += c;\r\n    }\r\n    return 0.5 * log(r) * r / dr - 0.001;\r\n  `,\r\n  lightFunc: /* wgsl */ `\r\n    let lightPos = toCartesian(vec3f(2, toSpherical(ro).yz));\r\n    let hue = toSpherical(pos).y + U.time * 0.2;\r\n    let diffuseColor = hsv2rgb(vec3f(hue, 0.5, 1));\r\n    let lightColor = hsv2rgb(vec3f(0.2));\r\n    let light = blinnPhong(\r\n      // Environment\r\n      rd, normal, /* minBright */ 0,\r\n      // Material\r\n      pos, diffuseColor, /* shininess */ 128,\r\n      // Light\r\n      lightPos, lightColor, /* power */ 8,\r\n    );\r\n    return vec4f(light, 1.);\r\n  `,\r\n})\r\n\r\nrt.camera = {\r\n  fov: 60,\r\n  pos: {\r\n    x: 0.6,\r\n    y: 0.8,\r\n    z: 1.5,\r\n  },\r\n  spherical: {\r\n    phi: -0.5,\r\n    radius: 0,\r\n    theta: 0.4,\r\n  },\r\n}\r\n\r\nfreeControls(rt)\r\n\r\nrt.start()\r\n&quot;]}],[0,{&quot;route&quot;:[0,&quot;rm-modeling&quot;],&quot;sketch&quot;:[0,&quot;import { ReTina } from &#39;@ReTina&#39;\r\nimport freeControls from &#39;./utils/freeControls&#39;\r\n\r\nconst rt = new ReTina({\r\n  showFps: true,\r\n})\r\n\r\n// Head\r\nrt.registerMaterial({\r\n  color: { r: 0.5, g: 0.5, b: 0.5 },\r\n  sdFunc: /* wgsl */ `\r\n    let dBox = sdBox(pos, vec3&lt;f32&gt;(0.26, 0.14, 0.08));\r\n    let dSphere = sdSphere(pos, 0.1);\r\n    return opSmoothUnion(dBox, dSphere, 0.5);\r\n  `,\r\n  lightFunc: /* wgsl */ `\r\n    let minBright = 0.5;\r\n    let diffuseColor = color;\r\n    let shininess = 256.;\r\n    let lightPos = toCartesian(vec3f(1.3, PI / 2., PI / 2.));\r\n    let lightColor = vec3f(1);\r\n    let power = 1.;\r\n    let light = blinnPhong(\r\n      // Environment\r\n      rd, normal, minBright,\r\n      // Material\r\n      pos, diffuseColor, shininess,\r\n      // Light\r\n      lightPos, lightColor, power,\r\n    );\r\n    return vec4f(light, 1.);\r\n  `,\r\n})\r\n\r\n// Sun glasses\r\nrt.registerMaterial({\r\n  pos: { x: 0, y: 0.03, z: 0.22 },\r\n  color: { r: 0, g: 0, b: 0 },\r\n  sdFunc: /* wgsl */ `\r\n    let left  = sdBox(pos - vec3&lt;f32&gt;(0.15, 0.0, 0.0), vec3&lt;f32&gt;(0.12, 0.08, 0.001));\r\n    let right = sdBox(pos - vec3&lt;f32&gt;(-0.15, 0.0, 0.0), vec3&lt;f32&gt;(0.12, 0.08, 0.001));\r\n    let mid = sdCapsule(pos - vec3&lt;f32&gt;(0.0, 0.04, 0.0), vec3&lt;f32&gt;(0.05, 0, 0), vec3&lt;f32&gt;(-0.05, 0, 0), 0.01);\r\n    return opSmoothUnion(min(left, right), mid, 0.02);\r\n  `,\r\n  lightFunc: /* wgsl */ `\r\n    let minBright = 0.;\r\n    let diffuseColor = color;\r\n    let shininess = 2056.;\r\n    let lightPos = toCartesian(vec3f(1.3, 0, 0));\r\n    let lightColor = vec3f(1);\r\n    let power = 2.;\r\n    let light = blinnPhong(\r\n      // Environment\r\n      rd, normal, minBright,\r\n      // Material\r\n      pos, diffuseColor, shininess,\r\n      // Light\r\n      lightPos, lightColor, power,\r\n    );\r\n    return vec4f(light, 1.);\r\n  `,\r\n})\r\n\r\n// Body\r\nrt.registerMaterial({\r\n  sdFunc: /* wgsl */ `\r\n    let dBody = sdCapsule(pos, vec3&lt;f32&gt;(0, -0.32, 0), vec3&lt;f32&gt;(0, -0.4, 0), 0.08);\r\n    let leftLeg = sdCapsule(pos, vec3&lt;f32&gt;(-0.04, -0.45, 0), vec3&lt;f32&gt;(-0.07, -0.55, 0), 0.05);\r\n    let rightLeg = sdCapsule(pos, vec3&lt;f32&gt;(0.04, -0.45, 0), vec3&lt;f32&gt;(0.07, -0.55, 0), 0.05);\r\n    let dLegs = min(leftLeg, rightLeg);\r\n    return opSmoothUnion(dBody, dLegs, 0.04);\r\n  `,\r\n  lightFunc: /* wgsl */ `\r\n    var n = snoise3d(pos * 20.);\r\n    n = snoise3d(vec3&lt;f32&gt;(pos.xy, n + U.time)) * 0.5 + 0.5;\r\n    n = pow(n, 2.0);\r\n    let c = hsv2rgb(vec3&lt;f32&gt;(pos.y + U.time, 1.0 - n, n));\r\n    let lambertian = dot(normal, -rd);\r\n    return vec4&lt;f32&gt;(c * lambertian, 1.);\r\n  `,\r\n})\r\n\r\n// Environment\r\nrt.registerMaterial({\r\n  color: { r: 0.4, g: 0.6, b: 0.6 },\r\n  sdFunc: /* wgsl */ `\r\n    let dFloor = sdBox(pos - vec3&lt;f32&gt;(0, -0.6, 0), vec3&lt;f32&gt;(1, 0.01, 0.3));\r\n    let dWall = sdBox(pos - vec3&lt;f32&gt;(0, 0, -0.3), vec3&lt;f32&gt;(1, 0.6, 0.01));\r\n    return min(dFloor, dWall);\r\n  `,\r\n})\r\n\r\nrt.camera.fov = 60\r\nrt.camera.spherical.radius = 1.2\r\nrt.camera.spherical.theta = 0.3\r\n\r\nfreeControls(rt)\r\n\r\nrt.start()\r\n&quot;]}],[0,{&quot;route&quot;:[0,&quot;rm-periodic-surface&quot;],&quot;sketch&quot;:[0,&quot;import { ReTina } from &#39;@ReTina&#39;\r\n\r\nconst rt = new ReTina()\r\n\r\nrt.registerMaterial({\r\n  sdFunc: `\r\n    let t = U.time * .3;\r\n    pos = rotate(pos, vec3&lt;f32&gt;(0, t, -t));\r\n    pos += vec3&lt;f32&gt;(cos(-t) * 16, 2.4, sin(-t) * 16);\r\n    return (sin(pos.y) - (cos(pos.x) + cos(pos.y) + cos(pos.z))) * .6;\r\n  `,\r\n  lightFunc: `\r\n    let lamb = dot(normal, -rd);\r\n    let aoFactor = calculateDFAO(pos, normal);\r\n    var c = (normal * .5 + .5) * sqrt(lamb) * aoFactor;\r\n    let dist = length(pos - ro);\r\n    let bri = pow(max(0, sin(dist * PI / 6.)), 6.) + U.pulse;\r\n    c *= bri;\r\n    return vec4(c, 1.);\r\n  `,\r\n})\r\n\r\nlet pulse = 0\r\nconst setPulse = rt.registerUniform(&#39;pulse&#39;, pulse)\r\n\r\nrt.canvas.addEventListener(&#39;click&#39;, () =&gt; {\r\n  pulse = 1\r\n})\r\n\r\nlet lastTime = performance.now()\r\nrt.start({\r\n  onFrame() {\r\n    const time = performance.now()\r\n    const pulseSlowdown = 0.1 / (time - lastTime)\r\n    pulse = Math.max(0, pulse - pulseSlowdown)\r\n    setPulse(pulse)\r\n    lastTime = time\r\n  },\r\n})\r\n&quot;]}],[0,{&quot;route&quot;:[0,&quot;rm-physics&quot;],&quot;sketch&quot;:[0,&quot;import { ReTina } from &#39;../_lib&#39;\r\nimport freeControls from &#39;./utils/freeControls&#39;\r\n\r\nconst rt = new ReTina({\r\n  showFps: true,\r\n  height: 256,\r\n  useInterlacing: true,\r\n})\r\n\r\nrt.registerMaterial({\r\n  sdFunc: /* wgsl */ `\r\n    var d = max(pos.y, -pos.y - 0.1);\r\n    d = max(d, -sdSphere(pos - vec3f(0, 0, -2), 1.5));\r\n    return d;\r\n  `,\r\n})\r\n\r\nrt.registerMaterial({\r\n  color: { r: 1, g: 0, b: 1 },\r\n  sdFunc: /* wgsl */ `\r\n    let t = U.time;\r\n    pos = pos - vec3f(2, 0.6 - sin(t) * 0.2, -2);\r\n    pos = rotate(pos, vec3f(0, t, 0));\r\n    return sdBox(pos, vec3f(1, 0.1, 1));\r\n  `,\r\n})\r\n\r\nconst player = rt.registerMaterial({\r\n  enableCollisions: true,\r\n  sdFunc: /* wgsl */ `\r\n    let camPos = vec3f(U.camPosX, U.camPosY, U.camPosZ);\r\n    let head = sdSphere(pos - camPos, 0.3);\r\n    let body = sdCapsule(pos - camPos, vec3f(0, 0, 0), vec3f(0, -0.6, 0), 0.2);\r\n    return opSmoothUnion(head, body, 0.2);\r\n  `,\r\n})\r\n\r\nrt.camera.fov = 90\r\nrt.camera.pos.y = 1\r\nrt.camera.spherical.radius = 2\r\nlet onTheGround = false\r\n\r\nconst { applyForce, setVelocity, getVelocity } = freeControls(rt, {\r\n  slowDown: {\r\n    x: 0.9,\r\n    y: 1,\r\n    z: 0.9,\r\n  },\r\n  onSpace: () =&gt; {\r\n    if (onTheGround) {\r\n      applyForce({ y: 0.01 })\r\n    }\r\n  },\r\n})\r\n\r\nlet processingCollisions = false\r\nsetInterval(() =&gt; {\r\n  if (!processingCollisions) {\r\n    processingCollisions = true\r\n    player.checkCollision().then((result) =&gt; {\r\n      if (result.materialIndex !== -1) {\r\n        const colDir = result.collisionNormal\r\n        const isGround = colDir.y &gt; 0.9\r\n\r\n        if (isGround) {\r\n          onTheGround = true\r\n          player.setColor({ r: 0.3, g: 0.9, b: 0.3 })\r\n\r\n          const currentVel = getVelocity()\r\n          if (currentVel.y &lt; 0) {\r\n            setVelocity({ y: 0 })\r\n          }\r\n        } else {\r\n          applyForce({\r\n            x: colDir.x * 0.3,\r\n            y: colDir.y * 0.3,\r\n            z: colDir.z * 0.3,\r\n          })\r\n        }\r\n      } else {\r\n        player.setColor({ r: 1, g: 1, b: 1 })\r\n        onTheGround = false\r\n      }\r\n    })\r\n    processingCollisions = false\r\n  }\r\n\r\n  if (!onTheGround) {\r\n    applyForce({ y: -0.005 })\r\n  }\r\n}, 1000 / 60)\r\n\r\nrt.start()\r\n&quot;]}],[0,{&quot;route&quot;:[0,&quot;rm-simplex-noise-terrain&quot;],&quot;sketch&quot;:[0,&quot;import { ReTina } from &#39;../_lib&#39;\r\n\r\nconst rt = new ReTina({\r\n  useInterlacing: true,\r\n  height: 256,\r\n  main: /* wgsl */ `\r\n    let scene = calcScene(uv);\r\n    var color = vec3f(0);\r\n    if scene.dist &gt; 0 {\r\n        color = round(scene.color.rgb * 16) / 16;\r\n    }\r\n    return vec4f(color, 1);\r\n  `,\r\n  functions: /* wgsl */ `\r\n    fn getLightPos() -&gt; vec3f {\r\n      return vec3f(0, 2, U.camPosZ - 10);\r\n    }\r\n  `,\r\n})\r\n\r\nrt.registerMaterial({\r\n  sdFunc: &#39;return sdSphere((pos - getLightPos()), 1);&#39;,\r\n  lightFunc: &#39;return vec4f(1);&#39;,\r\n})\r\n\r\nrt.registerMaterial({\r\n  sdFunc: /* wgsl */ `\r\n    let terrain = (pos.y - snoise3d(vec3f(pos.xz, pos.y - U.time / 10))) / 6;\r\n    let capsule = sdCapsule(pos, vec3f(U.camPosX, U.camPosY, U.camPosZ), getLightPos(), 0.2);\r\n    return opSmoothSubtraction(capsule, terrain, .1);\r\n  `,\r\n  lightFunc: /* wgsl */ `\r\n    let minBright = 0.1;\r\n    let diffuseColor = color;\r\n    let shininess = 1024f;\r\n    let lightPos = getLightPos();\r\n    let lightColor = vec3f(0.8, 0.9, 0.9);\r\n    let power = 128f;\r\n    let light = blinnPhong(\r\n      // Environment\r\n      rd, normal, minBright,\r\n      // Material\r\n      pos, diffuseColor, shininess,\r\n      // Light\r\n      lightPos, lightColor, power,\r\n    );\r\n    return vec4f(light, 1);\r\n  `,\r\n})\r\n\r\nrt.start({\r\n  onFrame() {\r\n    const t = performance.now() / 1000\r\n    rt.camera.pos = { x: 0, y: 0.6, z: -t / 4 }\r\n    rt.camera.spherical = { radius: 0.1, theta: Math.sin(t / 2) / 2, phi: -0.3 }\r\n  },\r\n})\r\n&quot;]}]]],&quot;data-astro-cid-ob7qyy3l&quot;:[0,true]}" ssr client="load" opts="{&quot;name&quot;:&quot;ReTinaExamples&quot;,&quot;value&quot;:true}" await-children><ul><li><a href="/re-tina/basic-cursors" target="_blank" class="underline text-primary">basic-cursors</a> — Click again to open in new tab</li><li><a href="/re-tina/basic-game-of-life" target="_blank" class="underline ">basic-game-of-life</a></li><li><a href="/re-tina/basic-voronoi" target="_blank" class="underline ">basic-voronoi</a></li><li><a href="/re-tina/rm-collisions" target="_blank" class="underline ">rm-collisions</a></li><li><a href="/re-tina/rm-fbm-terrain" target="_blank" class="underline ">rm-fbm-terrain</a></li><li><a href="/re-tina/rm-fractal-env" target="_blank" class="underline ">rm-fractal-env</a></li><li><a href="/re-tina/rm-mandelbulb" target="_blank" class="underline ">rm-mandelbulb</a></li><li><a href="/re-tina/rm-modeling" target="_blank" class="underline ">rm-modeling</a></li><li><a href="/re-tina/rm-periodic-surface" target="_blank" class="underline ">rm-periodic-surface</a></li><li><a href="/re-tina/rm-physics" target="_blank" class="underline ">rm-physics</a></li><li><a href="/re-tina/rm-simplex-noise-terrain" target="_blank" class="underline ">rm-simplex-noise-terrain</a></li></ul><iframe src="/re-tina/basic-cursors" height="400" width="100%"></iframe><h1>basic-cursors</h1><pre class="bg-[#282c34] relative"><button class="top-2 right-2 px-2 rounded absolute text-sm border">Copy</button><code class="hljs language-javascript overflow-x-auto whitespace-pre"><span class="hljs-keyword">import</span> <span class="hljs-title class_">ReTina</span> <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;../_lib/ReTina/ReTina&#x27;</span>
<span class="hljs-keyword">import</span> {
  init,
  changeState,
  listener,
  close,
  getMyId,
} <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;../../../shared/ants&#x27;</span>

type <span class="hljs-title class_">AntState</span> = {
  <span class="hljs-attr">x</span>: number
  <span class="hljs-attr">y</span>: number
  <span class="hljs-attr">id</span>: string
}

<span class="hljs-keyword">const</span> <span class="hljs-variable constant_">MAX_ANTS</span> = <span class="hljs-number">100</span>

<span class="hljs-keyword">const</span> rt = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ReTina</span>({
  <span class="hljs-attr">transparent</span>: <span class="hljs-literal">true</span>,
  <span class="hljs-attr">texs</span>: [{ <span class="hljs-attr">width</span>: <span class="hljs-variable constant_">MAX_ANTS</span>, <span class="hljs-attr">height</span>: <span class="hljs-number">1</span> }], <span class="hljs-comment">// Texture for ant positions</span>
  <span class="hljs-attr">functions</span>: <span class="hljs-comment">/* wgsl */</span> <span class="hljs-string">`
    fn unpack(h: f32, l: f32) -&gt; f32 {
      // Reconstruct 16-bit value from two 8-bit normalized floats
      // h is high byte/255, l is low byte/255
      let high = h * 255.0;
      let low = l * 255.0;
      let val16 = high * 256.0 + low;
      return val16 / 65535.0;
    }

    fn circle(uv: vec2f, center: vec2f, radius: f32) -&gt; f32 {
        let d = length(uv - center);
        return 1.0 - smoothstep(radius, radius + 2.0, d);
    }
  `</span>,
  <span class="hljs-attr">main</span>: <span class="hljs-comment">/* wgsl */</span> <span class="hljs-string">`
    let xy = uv * vec2f(U.width, U.height);
    var color = vec4f(0); // Background

    // Draw other ants
    let count = i32(U.antCount);
    for (var i: i32 = 0; i &lt; count; i++) {
        // Load packed position from texture
        // Texture is 100x1
        let texVal = textureLoad(tex0, vec2&lt;i32&gt;(i, 0), 0);
        let ax = unpack(texVal.r, texVal.g);
        let ay = unpack(texVal.b, texVal.a);
        let pos = vec2f(ax, ay) * vec2f(U.width, U.height);

        // Simple visual for ant: Circle
        // Different color based on ID/Index? We don&#x27;t have ID in texture, just index.
        let hue = f32(i) / f32(10.0);
        let antColor = hsv2rgb(vec3f(hue, 0.8, 0.9));
        let c = circle(xy, pos, 15.0);
        color = mix(color, vec4f(antColor, 1), c);
    }

    // Draw local mouse (white ring)
    let mousePos = vec2f(U.mouseX, U.mouseY);
    let m = circle(xy, mousePos, 10.0) - circle(xy, mousePos, 8.0); 
    color = mix(color, vec4f(1, 0, 0, 1), max(0.0, m));

    return color;
  `</span>,
})

<span class="hljs-keyword">const</span> setMouseX = rt.<span class="hljs-title function_">registerUniform</span>(<span class="hljs-string">&#x27;mouseX&#x27;</span>)
<span class="hljs-keyword">const</span> setMouseY = rt.<span class="hljs-title function_">registerUniform</span>(<span class="hljs-string">&#x27;mouseY&#x27;</span>)
<span class="hljs-keyword">const</span> setAntCount = rt.<span class="hljs-title function_">registerUniform</span>(<span class="hljs-string">&#x27;antCount&#x27;</span>)

<span class="hljs-comment">// Helper to pack float 0..1 into two bytes [high, low]</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">pack16</span>(<span class="hljs-params">val: number</span>) {
  <span class="hljs-keyword">const</span> v = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">max</span>(<span class="hljs-number">0</span>, <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">min</span>(<span class="hljs-number">1</span>, val)) * <span class="hljs-number">65535</span>
  <span class="hljs-keyword">const</span> high = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">floor</span>(v / <span class="hljs-number">256</span>)
  <span class="hljs-keyword">const</span> low = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">floor</span>(v % <span class="hljs-number">256</span>)
  <span class="hljs-keyword">return</span> [high, low]
}

rt.<span class="hljs-title function_">start</span>({
  <span class="hljs-title function_">onBuild</span>(<span class="hljs-params"></span>) {
    <span class="hljs-title function_">init</span>()

    <span class="hljs-keyword">const</span> myId = <span class="hljs-title function_">getMyId</span>()

    <span class="hljs-title function_">listener</span>(<span class="hljs-function">(<span class="hljs-params">states: AntState[]</span>) =&gt;</span> {
      <span class="hljs-keyword">const</span> remoteAnts = states.<span class="hljs-title function_">filter</span>(
        <span class="hljs-function">(<span class="hljs-params">s</span>) =&gt;</span>
          s.<span class="hljs-property">id</span> &amp;&amp;
          s.<span class="hljs-property">id</span> !== myId &amp;&amp;
          <span class="hljs-keyword">typeof</span> s.<span class="hljs-property">x</span> === <span class="hljs-string">&#x27;number&#x27;</span> &amp;&amp;
          <span class="hljs-keyword">typeof</span> s.<span class="hljs-property">y</span> === <span class="hljs-string">&#x27;number&#x27;</span>
      )

      <span class="hljs-title function_">setAntCount</span>(remoteAnts.<span class="hljs-property">length</span>)

      <span class="hljs-comment">// Update texture</span>
      <span class="hljs-keyword">const</span> data = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Uint8Array</span>(<span class="hljs-variable constant_">MAX_ANTS</span> * <span class="hljs-number">4</span>) <span class="hljs-comment">// RGBA per pixel</span>
      remoteAnts.<span class="hljs-title function_">forEach</span>(<span class="hljs-function">(<span class="hljs-params">ant, i</span>) =&gt;</span> {
        <span class="hljs-keyword">if</span> (i &gt;= <span class="hljs-variable constant_">MAX_ANTS</span>) <span class="hljs-keyword">return</span>

        <span class="hljs-keyword">const</span> [xh, xl] = <span class="hljs-title function_">pack16</span>(ant.<span class="hljs-property">x</span>)
        <span class="hljs-keyword">const</span> [yh, yl] = <span class="hljs-title function_">pack16</span>(ant.<span class="hljs-property">y</span>)

        <span class="hljs-keyword">const</span> idx = i * <span class="hljs-number">4</span>
        data[idx] = xh <span class="hljs-comment">// R</span>
        data[idx + <span class="hljs-number">1</span>] = xl <span class="hljs-comment">// G</span>
        data[idx + <span class="hljs-number">2</span>] = yh <span class="hljs-comment">// B</span>
        data[idx + <span class="hljs-number">3</span>] = yl <span class="hljs-comment">// A</span>
      })

      rt.<span class="hljs-title function_">setTex</span>(<span class="hljs-number">0</span>, data)
    })

    <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">&#x27;mousemove&#x27;</span>, <span class="hljs-function">(<span class="hljs-params">event</span>) =&gt;</span> {
      <span class="hljs-keyword">const</span> rect = rt.<span class="hljs-property">canvas</span>.<span class="hljs-title function_">getBoundingClientRect</span>()
      <span class="hljs-keyword">const</span> x = event.<span class="hljs-property">clientX</span> - rect.<span class="hljs-property">left</span>
      <span class="hljs-keyword">const</span> y = event.<span class="hljs-property">clientY</span> - rect.<span class="hljs-property">top</span>
      <span class="hljs-title function_">setMouseX</span>(x)
      <span class="hljs-title function_">setMouseY</span>(y)

      <span class="hljs-keyword">const</span> nx = x / rect.<span class="hljs-property">width</span>
      <span class="hljs-keyword">const</span> ny = y / rect.<span class="hljs-property">height</span>

      <span class="hljs-title function_">changeState</span>({ <span class="hljs-attr">id</span>: myId, <span class="hljs-attr">x</span>: nx, <span class="hljs-attr">y</span>: ny })
    })

    <span class="hljs-variable language_">window</span>.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">&#x27;beforeunload&#x27;</span>, <span class="hljs-function">() =&gt;</span> {
      <span class="hljs-title function_">close</span>()
    })
  },
})
</code></pre><!--astro:end--></astro-island> </main>  </body></html> <footer class="py-16 flex justify-between max-w-2xl m-auto p-2" data-astro-cid-ob7qyy3l> <p data-astro-cid-ob7qyy3l>
© 2025. All content and pages are licensed under
<a target="_blank" href="https://creativecommons.org/licenses/by-sa/4.0/" class="hover:text-white" data-astro-cid-ob7qyy3l>CC BY-SA 4.0</a> </p> <a href="/" data-astro-cid-ob7qyy3l>Home</a> </footer> 